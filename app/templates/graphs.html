<html>
	<head>
		<link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script>window.jQuery || document.write('<script src="{{url_for('static', filename='jquery.js') }}">\x3C/script>')</script>
		<script src="http://code.highcharts.com/highcharts.js"></script>
		<script src="http://code.highcharts.com/modules/exporting.js"></script>
		
		<script type=text/javascript>
			function update()
			{
				$.getJSON(                            	
					'/_get_history?hours=24',					
					{},									
					function(data)						
					{
						//Fit data into bins
						var bins = Array.apply(null, new Array(24)).map(Number.prototype.valueOf,0);
						var binCt = Array.apply(null, new Array(24)).map(Number.prototype.valueOf,0);
						var avgTemps = Array.apply(null, new Array(24)).map(Number.prototype.valueOf,0);
						var avgTempCt = Array.apply(null, new Array(24)).map(Number.prototype.valueOf,0);
						var i;
						var tInit = data.opTimes[0];
						for(i=0; i < data.opTimes.length; i++)
						{
							data.opTimes[i] = data.opTimes[i] - tInit;
							if(data.opModes[i] == 5 || data.opModes[i] == 8)
							{
								bins[Math.floor(data.opTimes[i] / 3600) ]++;
							}
							binCt[Math.floor(data.opTimes[i] / 3600) ]++;
						}
						
						//compute average temperatures for each hour
						var tInit = data.extTempTimes[0];
						for(i=0; i < data.extTempTimes.length; i++)
						{
							data.extTempTimes[i] = data.extTempTimes[i] - tInit;
							avgTemps[Math.floor(data.extTempTimes[i] / 3600) ] += data.extTemps[i]*9/5+32;
							avgTempCt[Math.floor(data.extTempTimes[i] / 3600) ]++;
						}
						
						//Normalize bins to percentages and average temperatures
						for(i = 0; i < bins.length; i++)
						{
							bins[i] = bins[i]/binCt[i]*100;
							avgTemps[i] = avgTemps[i] / avgTempCt[i];
						}
						
						//Pair up unix time & temperature data
						var intTempLog = []
						for(i = 0; i < data.opTimes.length; i++)
						{
							intTempLog[i] = [new Date(data.opTimes[i]*1000), data.indTemps[i]*9/5+32];
						}
						
						//Format data into chart
						$('#dutyCycleContainer').highcharts({
							chart: {
								zoomType: 'xy'
							},
							title: {
								text: 'Ext. Temperature and Duty Cycle'
							},
							subtitle: {
								text: 'Calculated from database'
							},
							xAxis: [{
								categories: ["-24h", "-23h", "-22h", "-21h", "-20h", "-19h", "-18h", "-17h", "-16h", "-15h", "-14h", "-13h", "-12h", "-11h", "-10h", "-9h", "-8h", "-7h", "-6h", "-5h", "-4h", "-3h", "-2h", "-1h"]
							}],
							yAxis: [{ // Primary yAxis
								labels: {
									format: '{value} F',
									style: {
										color: Highcharts.getOptions().colors[1]
									}
								},
								title: {
									text: 'Temperature',
									style: {
										color: Highcharts.getOptions().colors[1]
									}
								}
							}, { // Secondary yAxis
								title: {
									text: 'Duty Cycle',
									style: {
										color: Highcharts.getOptions().colors[0]
									}
								},
								labels: {
									format: '{value}%',
									style: {
										color: Highcharts.getOptions().colors[0]
									}
								},
								opposite: true
							}],
							tooltip: {
								shared: true
							},
							series: [{
								name: 'Duty Cycle',
								type: 'column',
								yAxis: 1,
								data: bins,
								tooltip: {
									valueSuffix: ' %'
								}

							}, {
								name: 'Ext. Temperature',
								type: 'spline',
								data: avgTemps,
								tooltip: {
									valueSuffix: ' F'
								}
							}]
						});
						
						$('#tempLogContainer').highcharts({
							chart: {
								zoomType: 'x'
							},
							title: {
								text: 'Indoor temperature, past 24 hours'
							},
							xAxis: {
								text: 'Unix Time'
							},
							yAxis: {
								title: {
									text: 'Indoor Temperature (F)'
								}
							},
							legend: {
								enabled: false
							},
							plotOptions: {
								area: {
									fillColor: {
										linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1},
										stops: [
											[0, Highcharts.getOptions().colors[0]],
											[1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
										]
									},
									marker: {
										radius: 2
									},
									lineWidth: 1,
									states: {
										hover: {
											lineWidth: 1
										}
									},
									threshold: null
								}
							},

							series: [{
								type: 'area',
								name: 'Indoor Temperature (F)',
								data: intTempLog
							}]
						});
					});
			}
			
			update();
		</script>
		<title>{{ title }}</title>
	</head>
	<body>
		<div id="nav">
			<ul>
				<li><a href="index">home</a></li>
				<li><a href="override">override</a></li>
				<li><a href="config">config</a></li>
				<li><a href="schedule">schedule</a></li>
				<li><a href="graphs">graphs</a></li>
			</ul>
		</div>
		
		<div id="dutyCycleContainer" style="min-width: 350px; height: 400px; margin: 0 auto">Loading...</div>
		<div id="tempLogContainer" style="min-width: 350px; height: 400px; margin: 0 auto">Loading...</div>
		
	</body>
</html>